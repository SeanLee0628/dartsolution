(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const t of o)if(t.type==="childList")for(const s of t.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function a(o){const t={};return o.integrity&&(t.integrity=o.integrity),o.referrerPolicy&&(t.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?t.credentials="include":o.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function r(o){if(o.ep)return;o.ep=!0;const t=a(o);fetch(o.href,t)}})();const E="577d4d3fff35faf9705ef7383b323d98e87a84bd",L="87d0bffe5d1544a89e2d299ad91baff546740fd4e83ccf0b4d2986c804c8b8b7",S="/api",_="/stock-api",f={companyInput:document.getElementById("companyInput"),searchBtn:document.getElementById("searchBtn"),status:document.getElementById("search-status"),results:document.getElementById("results-section"),displayCompany:document.getElementById("displayCompanyName"),loading:document.getElementById("loading-overlay"),tableHeader:document.getElementById("tableHeader"),tableBody:document.getElementById("tableBody")};let y=null,m=null;const N={q1:"11013",q2:"11012",q3:"11014",q4:"11011"};let k=null;async function B(){if(k)return k;try{return k=await(await fetch("/corp_codes.json")).json(),k}catch(e){return console.error("Failed to load corp codes",e),{}}}async function P(e){try{I("데이터베이스에서 회사를 찾는 중...","info");const n=await B(),a=e.trim();if(n[a])return y=n[a],m=a,{corpCode:y,corpName:m};const r=a.toLowerCase(),o=Object.keys(n),t=o.find(c=>c.toLowerCase()===r);if(t)return y=n[t],m=t,{corpCode:y,corpName:m};const s=o.filter(c=>c.toLowerCase().includes(r));return s.length>0?(s.sort((c,i)=>{const p=c.toLowerCase().startsWith(r),l=i.toLowerCase().startsWith(r);return p&&!l?-1:!p&&l?1:c.length-i.length}),m=s[0],y=n[m],{corpCode:y,corpName:m}):await O(e)}catch(n){throw I(n.message,"error"),n}}async function O(e){const n=`${S}/list.json?crtfc_key=${E}&corp_name=${encodeURIComponent(e)}&bgn_de=20240101`,r=await(await fetch(n)).json();if(r.status==="000"){const o=r.list[0];return y=o.corp_code,m=o.corp_name,{corpCode:y,corpName:m}}throw new Error("회사를 찾을 수 없습니다.")}function j(){const e=[];let n=2025,a=3;for(let r=0;r<20;r++)e.push({year:n.toString(),q:`q${a}`}),a--,a<1&&(a=4,n--);return e}async function R(e){q(!0);const n=j(),a=[];try{for(let r=0;r<n.length;r+=5){const t=n.slice(r,r+5).map(c=>fetch(`${S}/fnlttSinglAcntAll.json?crtfc_key=${E}&corp_code=${e}&bsns_year=${c.year}&reprt_code=${N[c.q]}&fs_div=CFS`).then(i=>i.json()).then(i=>({year:c.year,q:c.q,data:i.status==="000"?D(i.list):{error:i.message}}))),s=await Promise.all(t);a.push(...s)}return F(a),a}catch(r){console.error(r),I("데이터를 불러오지 못했습니다.","error")}finally{q(!1)}}function D(e){const n={},a=t=>e.find(s=>t.includes(s.account_nm.replace(/\s/g,"").replace("(손실)","")));if([{key:"revenue",names:["매출액","수익(매출액)","영업수익"]},{key:"costOfSales",names:["매출원가","영업원가"]},{key:"grossProfit",names:["매출총이익","매출총손익"]},{key:"operatingIncome",names:["영업이익"]},{key:"netIncome",names:["당기순이익","연결당기순이익","분기순이익","반기순이익"]},{key:"totalAssets",names:["자산총계"]},{key:"totalLiabilities",names:["부채총계"]},{key:"totalEquity",names:["자본총계"]}].forEach(t=>{const s=a(t.names);if(s){const c=BigInt(s.thstrm_amount.replace(/,/g,""));n[t.key]={raw:c,formatted:C(c)}}else n[t.key]={raw:0n,formatted:"-"}}),n.revenue.raw!==0n&&n.costOfSales.raw!==0n){const t=n.revenue.raw-n.costOfSales.raw;n.grossProfit={raw:t,formatted:C(t)}}const o=e.find(t=>t.account_nm.includes("계속영업기본주당이익"))||e.find(t=>t.account_nm.includes("기본주당이익"))||e.find(t=>t.account_nm.includes("기본주당순이익"))||e.find(t=>t.account_nm.includes("기본주당분기순이익"))||e.find(t=>t.account_nm.includes("기본주당반기순이익"))||e.find(t=>t.account_nm.includes("주당순이익"));if(o){const t=parseFloat(o.thstrm_amount.replace(/,/g,""));n.eps={raw:t,formatted:v(t)}}else n.eps={raw:0,formatted:"-"};return n}function F(e){const n=(r,o)=>e.find(t=>t.year===r&&t.q===o),a=["revenue","grossProfit","operatingIncome","netIncome"];e.forEach(r=>{if(!r.data.error&&r.q==="q4"){const o=n(r.year,"q1"),t=n(r.year,"q2"),s=n(r.year,"q3");a.forEach(c=>{var d,u,h;const i=r.data[c].raw;if(i===0n)return;const p=(((d=o==null?void 0:o.data[c])==null?void 0:d.raw)||0n)+(((u=t==null?void 0:t.data[c])==null?void 0:u.raw)||0n)+(((h=s==null?void 0:s.data[c])==null?void 0:h.raw)||0n),l=i-p;r.data[c].displayVal=C(l)})}})}function C(e){if(e==null||e==="-")return"-";let n=Number(typeof e=="bigint"?e:e.toString().replace(/,/g,""));if(n===0)return"0 원";const a=n<0,r=Math.abs(n);let o;return r>=1e12?o=(r/1e12).toFixed(2)+"조":o=(r/1e8).toFixed(2)+"억",(a?"-":"")+o+" 원"}function v(e){if(e==null||e==="-")return"-";const n=parseFloat(e.toString().replace(/,/g,""));return isNaN(n)?e:new Intl.NumberFormat("ko-KR").format(Math.round(n))+" 원"}function A(e,n={}){f.displayCompany.textContent=m,f.results.classList.remove("hidden"),setTimeout(()=>f.results.classList.add("show"),10),f.tableHeader.innerHTML="<th>항목</th>"+e.map(r=>`<th>${r.year}년 ${r.q.toUpperCase()}</th>`).join("");const a=[{label:"매출액",key:"revenue"},{label:"매출총이익",key:"grossProfit"},{label:"영업이익",key:"operatingIncome"},{label:"당기순이익",key:"netIncome"},{label:"자산총액",key:"totalAssets"},{label:"부채총액",key:"totalLiabilities"},{label:"자본총액",key:"totalEquity"},{label:"EPS",key:"eps"}];f.tableBody.innerHTML=a.map(r=>`<tr>
            <td>${r.label}</td>
            ${e.map(o=>{if(o.data.error)return"<td>-</td>";const t=o.data[r.key];return`<td>${t.displayVal||t.formatted}</td>`}).join("")}
        </tr>`).join("");{const o=[{label:"주가 (종가)",type:"close"},{label:"PBR",type:"pbr"}].map(t=>`<tr>
                <td>${t.label}</td>
                ${e.map(s=>{const c=`${s.year}-${s.q}`,i=n[c];if(!i)return"<td>-</td>";if(t.type==="close")return`<td>${new Intl.NumberFormat("ko-KR").format(i.close)} 원</td>`;if(t.type==="pbr"){const p=s.data.totalEquity?s.data.totalEquity.raw:0,l=Number(p);return i.marketCap&&l>0?`<td>${(i.marketCap/l).toFixed(2)}배</td>`:"<td>-</td>"}return"<td>-</td>"}).join("")}
            </tr>`).join("");f.tableBody.innerHTML+=o}}function I(e,n){f.status.textContent=e,f.status.className=`status-msg ${n}`}function q(e){e?f.loading.classList.remove("hidden"):f.loading.classList.add("hidden")}async function M(e,n,a){var r,o,t;try{const s=`${_}/getStockPriceInfo?serviceKey=${L}&numOfRows=5000&resultType=json&itmsNm=${encodeURIComponent(e)}&beginBasDt=${n}&endBasDt=${a}`,p=((t=(o=(r=(await(await fetch(s)).json()).response)==null?void 0:r.body)==null?void 0:o.items)==null?void 0:t.item)||[],l={};return p.forEach(d=>{const u=d.basDt,h=parseInt(u.substring(0,4)),b=parseInt(u.substring(4,6));let g;b<=3?g="q1":b<=6?g="q2":b<=9?g="q3":g="q4";const w=`${h}-${g}`;l[w]||(l[w]={dates:[],totalVol:0,totalVal:0}),l[w].dates.push({date:u,close:parseInt(d.clpr),vol:parseInt(d.trqu),val:parseInt(d.trPrc),marketCap:parseFloat(d.mrktTotAmt),issuedShares:parseInt(d.lstgStCnt)}),l[w].totalVol+=parseInt(d.trqu),l[w].totalVal+=parseInt(d.trPrc)}),Object.keys(l).forEach(d=>{const u=l[d];u.dates.sort((h,b)=>b.date.localeCompare(h.date)),u.close=u.dates[0].close,u.marketCap=u.dates[0].marketCap,u.issuedShares=u.dates[0].issuedShares}),l}catch(s){return console.warn("Stock data fetch failed",s),{}}}async function $(){const e=f.companyInput.value.trim();if(e)try{const{corpCode:n}=await P(e),a=new Date().toISOString().slice(0,10).replace(/-/g,""),r="20200101",[o,t]=await Promise.all([R(n),M(m,r,a)]);o&&(A(o,t),I(`'${m}' 최근 20개 분기 데이터를 불러왔습니다.`,"info"))}catch(n){console.error(n)}}f.searchBtn.addEventListener("click",$);f.companyInput.addEventListener("keypress",e=>{e.key==="Enter"&&$()});
